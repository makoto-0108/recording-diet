<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒ¬ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 700px;
    margin: 20px auto;
    padding: 10px;
    background: #f9f9f9;
    color: #333;
  }
  h1 {
    text-align: center;
    color: #3498db; /* ãƒœã‚¿ãƒ³è‰²ã¨çµ±ä¸€ */
  }
  .intro {
    background: #eaf2fb;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 20px;
    text-align: center;
  }
  .intro p {
    margin: 5px 0 0;
    font-size: 1rem;
  }
  label {
    display: block;
    margin: 10px 0 5px;
    font-weight: bold;
  }
  input, textarea {
    width: 100%;
    padding: 8px;
    font-size: 1rem;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  button {
    margin-top: 10px;
    background-color: #3498db;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  button:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(52, 152, 219, 0.4);
  }
  .section {
    background: white;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  ul.record-list {
    list-style: none;
    padding-left: 0;
  }
  ul.record-list li {
    background: #e9f1f7;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 8px;
    position: relative;
  }
  ul.record-list li button {
    font-size: 0.9rem;
    padding: 4px 8px;
    position: absolute;
    top: 10px;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 5px;
  }
  ul.record-list li button.delete-btn {
    background-color: #e74c3c;
    right: 10px;
  }
  ul.record-list li button.edit-btn {
    background-color: #f39c12;
    right: 70px;
  }
  #copy-textarea {
    width: 100%;
    height: 120px;
    margin-top: 10px;
    resize: vertical;
  }
  #open-chatgpt {
    background-color: #2ecc71;
    margin-top: 10px;
  }
</style>
</head>
<body>

<h1>ãƒ¬ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ</h1>

<div class="intro">
  <p>ğŸ‰ ä½¿ã„æ–¹ã¯ç°¡å˜ï¼</p>
  <p>ä»Šæ—¥ã®é£Ÿäº‹ãƒ»ã‚«ãƒ­ãƒªãƒ¼ãƒ»æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼ãƒ»ä½“é‡ã‚’å…¥åŠ›</p>
  <p>ã€Œã¾ã¨ã‚ã‚³ãƒ”ãƒ¼ã€ãƒœã‚¿ãƒ³ã§ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼</p>
  <p>ChatGPTã«è²¼ã‚Šä»˜ã‘ã¦ã€Œã‚«ãƒ­ãƒªãƒ¼åˆè¨ˆã‚’æ•™ãˆã¦ï¼ã€ã¨é€ä¿¡</p>
  <p>ä»Šæ—¥ã®æ‘‚å–é‡ã‚„ä»£è¬ã¨ã®å·®ã‚‚ã™ããƒã‚§ãƒƒã‚¯ã§ãã¾ã™âœ¨</p>
</div>

<!-- ä»Šæ—¥ã®ã‚«ãƒ­ãƒªãƒ¼å·®è¡¨ç¤º -->
<div class="section" id="calorie-diff-section" style="text-align:center; background:#eaf2fb; padding:10px; border-radius:8px; margin-bottom:20px;">
  <h2 style="margin:0; font-size:1.2rem; color:#3498db;">ä»Šæ—¥ã®æ‘‚å–ãƒ»ä»£è¬å·®</h2>
  <p id="calorie-diff" style="margin:5px 0 0; font-size:1rem;">
    ä»Šæ—¥ã®æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼ã¨åŸºç¤ä»£è¬ã¨ã®å·®ã‚’ã“ã“ã«è¡¨ç¤º
  </p>
</div>

<div class="section">
  <label for="date-input">æ—¥ä»˜ã‚’é¸æŠ</label>
  <input type="date" id="date-input" />

  <label for="meal-input">é£Ÿäº‹å†…å®¹</label>
  <textarea id="meal-input" rows="3" placeholder="ä¾‹: åµã‹ã‘ã”é£¯ã€å‘³å™Œæ±ã€ã‚µãƒ©ãƒ€"></textarea>

  <label for="calorie-input">åˆè¨ˆã‚«ãƒ­ãƒªãƒ¼ï¼ˆkcalï¼‰</label>
  <input type="number" id="calorie-input" placeholder="ä¾‹: 550" />

  <label for="burncal-input">æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼ï¼ˆä»»æ„ï¼‰</label>
  <input type="number" id="burncal-input" placeholder="ä¾‹: 200" />

  <label for="weight-input">ä½“é‡ï¼ˆkgï¼‰</label>
  <input type="number" step="0.1" id="weight-input" placeholder="ä¾‹: 62.4" />

  <label for="memo-input">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
  <textarea id="memo-input" rows="2" placeholder="ä¾‹: ç–²ã‚Œã¦ã„ã¦å°‘ãªã‚ã«ã—ã¾ã—ãŸ"></textarea>

  <button id="add-record-btn">è¨˜éŒ²ã‚’è¿½åŠ </button>
</div>

<div class="section">
  <label for="filter-date">æ—¥ä»˜ã§è¡¨ç¤º</label>
  <input type="date" id="filter-date">
</div>

<div class="section">
  <h2>è¨˜éŒ²ä¸€è¦§</h2>
  <ul id="record-list" class="record-list"></ul>
</div>

<div class="section">
  <h2>ä½“é‡æ¨ç§»ã‚°ãƒ©ãƒ•</h2>
  <canvas id="weightChart" height="200"></canvas>
</div>

<div class="section">
  <h2>ã¾ã¨ã‚ã‚³ãƒ”ãƒ¼ç”¨ãƒ†ã‚­ã‚¹ãƒˆ</h2>
  <textarea id="copy-textarea" readonly placeholder="ã“ã“ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒãƒ£ãƒƒãƒ”ãƒ¼ï¼ˆChatGPTï¼‰ã«ãƒšãƒ¼ã‚¹ãƒˆã™ã‚‹ã¨æ¦‚ç®—ã‚«ãƒ­ãƒªãƒ¼ãŒã‚ã‹ã‚Šã¾ã™"></textarea>
  <button id="copy-all-btn">å…¨éƒ¨ã‚³ãƒ”ãƒ¼</button>
  <button id="open-chatgpt">ãƒãƒ£ãƒƒãƒ”ãƒ¼ã«ã‚«ãƒ­ãƒªãƒ¼ã«ã¤ã„ã¦èã„ã¦ã¿ã‚‹ã€‚</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const dateInput = document.getElementById('date-input');
  const mealInput = document.getElementById('meal-input');
  const calorieInput = document.getElementById('calorie-input');
  const burncalInput = document.getElementById('burncal-input');
  const weightInput = document.getElementById('weight-input');
  const memoInput = document.getElementById('memo-input');
  const addRecordBtn = document.getElementById('add-record-btn');
  const recordList = document.getElementById('record-list');
  const copyTextarea = document.getElementById('copy-textarea');
  const copyAllBtn = document.getElementById('copy-all-btn');
  const openChatGPTBtn = document.getElementById('open-chatgpt');
  const filterDateInput = document.getElementById('filter-date');
  const ctx = document.getElementById('weightChart').getContext('2d');
  const calorieDiffElem = document.getElementById('calorie-diff');
  const BASAL_METABOLISM = 1200;

  let records = [];
  let editIndex = null;
  let chart;

  function saveRecords() {
    localStorage.setItem('dietRecords', JSON.stringify(records));
  }

  const saved = localStorage.getItem('dietRecords');
  if (saved) { records = JSON.parse(saved); }

  function formatDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    return d.toLocaleDateString('ja-JP');
  }

  function renderRecords(filterDate = '') {
    recordList.innerHTML = '';
    const filtered = filterDate ? records.filter(r => r.date === filterDate) : records;
    filtered.forEach((rec, i) => {
      const li = document.createElement('li');
      li.innerHTML = `
        <strong>${formatDate(rec.date)}</strong><br/>
        é£Ÿäº‹: ${rec.meal}<br/>
        ã‚«ãƒ­ãƒªãƒ¼: ${rec.calorie ? rec.calorie + ' kcal' : 'æœªå…¥åŠ›'}<br/>
        æ¶ˆè²»: ${rec.burncal ? rec.burncal + ' kcal' : '-'}<br/>
        ä½“é‡: ${rec.weight ? rec.weight + ' kg' : 'æœªå…¥åŠ›'}<br/>
        ãƒ¡ãƒ¢: ${rec.memo || '-'}
        <button class="edit-btn" data-index="${i}">ç·¨é›†</button>
        <button class="delete-btn" data-index="${i}">å‰Šé™¤</button>
      `;
      recordList.appendChild(li);
    });
    updateCopyText(filtered);
    updateChart(filtered);
    updateCalorieDiff();
  }

  function updateCopyText(data) {
    if(data.length === 0) { copyTextarea.value = ''; return; }
    const sortedByDate = [...data].sort((a,b) => b.date.localeCompare(a.date));
    const latestDate = sortedByDate[0].date;
    const latestRecords = data.filter(r => r.date === latestDate);
    let text = latestRecords.map(r => {
      return `${formatDate(r.date)} é£Ÿäº‹: ${r.meal} (${r.calorie ? r.calorie + ' kcal' : 'ã‚«ãƒ­ãƒªãƒ¼æœªå…¥åŠ›'})` +
             `${r.burncal ? ' æ¶ˆè²»: ' + r.burncal + ' kcal' : ''} ä½“é‡: ${r.weight ? r.weight + ' kg' : 'æœªå…¥åŠ›'} ãƒ¡ãƒ¢: ${r.memo || '-'}`;
    }).join('\n');
    copyTextarea.value = text;
  }

  function updateChart(data) {
    const dateMap = {};
    data.forEach(r => { if (r.weight) {
      if (!dateMap[r.date] || new Date(r.date) > new Date(dateMap[r.date].time)) {
        dateMap[r.date] = {weight: parseFloat(r.weight), time: r.date};
      }
    }});
    const sortedDates = Object.keys(dateMap).sort((a,b) => new Date(a) - new Date(b));
    const labels = sortedDates.map(d => formatDate(d));
    const weights = sortedDates.map(d => dateMap[d].weight);
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'ä½“é‡ (kg)',
          data: weights,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52, 152, 219, 0.2)',
          fill: true,
          tension: 0.1
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: false } } }
    });
  }

  function updateCalorieDiff() {
    const today = new Date().toISOString().slice(0,10);
    const todayRecords = records.filter(r => r.date === today);
    const totalIntake = todayRecords.reduce((sum, r) => sum + (parseFloat(r.calorie)||0), 0);
    const totalBurn = todayRecords.reduce((sum, r) => sum + (parseFloat(r.burncal)||0), 0);
    const diff = totalIntake - totalBurn - BASAL_METABOLISM;

    let arrow = diff > 0 ? 'â†‘' : 'â†“';
    calorieDiffElem.textContent = `ä»Šæ—¥ã®æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼ã¨åŸºç¤ä»£è¬ã¨ã®å·®: ${diff} kcal ${arrow}`;
    calorieDiffElem.style.color = diff > 0 ? 'red' : 'green';
  }

  addRecordBtn.addEventListener('click', () => {
    const dateVal = dateInput.value;
    const mealVal = mealInput.value.trim();
    const calorieVal = calorieInput.value.trim();
    const burncalVal = burncalInput.value.trim();
    const weightVal = weightInput.value.trim();
    const memoVal = memoInput.value.trim();

    if(!dateVal) { alert('æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
    if(!mealVal && !weightVal) { alert('é£Ÿäº‹ã¾ãŸã¯ä½“é‡ã®ã©ã¡ã‚‰ã‹ã¯å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

    if(editIndex !== null) {
      records[editIndex] = {date: dateVal, meal: mealVal, calorie: calorieVal, burncal: burncalVal, weight: weightVal, memo: memoVal};
      editIndex = null;
      addRecordBtn.textContent = 'è¨˜éŒ²ã‚’è¿½åŠ ';
