<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>レコーディングダイエット</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 700px;
    margin: 20px auto;
    padding: 10px;
    background: #f9f9f9;
    color: #333;
  }
  h1 {
    text-align: center;
    color: #2c3e50;
  }
  label {
    display: block;
    margin: 10px 0 5px;
    font-weight: bold;
  }
  input, textarea {
    width: 100%;
    padding: 8px;
    font-size: 1rem;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  button {
    margin-top: 10px;
    background-color: #3498db;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  button:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(52, 152, 219, 0.4);
  }
  .section {
    background: white;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  ul.record-list {
    list-style: none;
    padding-left: 0;
  }
  ul.record-list li {
    background: #e9f1f7;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 8px;
    position: relative;
  }
  ul.record-list li button {
    font-size: 0.9rem;
    padding: 4px 8px;
    position: absolute;
    top: 10px;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 5px;
  }
  ul.record-list li button.delete-btn {
    background-color: #e74c3c;
    right: 10px;
  }
  ul.record-list li button.edit-btn {
    background-color: #f39c12;
    right: 70px;
  }
  #copy-textarea {
    width: 100%;
    height: 120px;
    margin-top: 10px;
    resize: vertical;
  }
  #open-chatgpt {
    background-color: #2ecc71;
    margin-top: 10px;
  }
</style>
</head>
<body>

<h1>レコーディングダイエット</h1>

<div class="section">
  <label for="date-input">日付を選択</label>
  <input type="date" id="date-input" />

  <label for="meal-input">食事内容</label>
  <textarea id="meal-input" rows="3" placeholder="例: 卵かけご飯、味噌汁、サラダ"></textarea>

  <label for="calorie-input">合計カロリー（kcal）</label>
  <input type="number" id="calorie-input" placeholder="例: 550" />

  <label for="burncal-input">消費カロリー（任意）</label>
  <input type="number" id="burncal-input" placeholder="例: 200" />

  <label for="weight-input">体重（kg）</label>
  <input type="number" step="0.1" id="weight-input" placeholder="例: 62.4" />

  <label for="memo-input">メモ（任意）</label>
  <textarea id="memo-input" rows="2" placeholder="例: 疲れていて少なめにしました"></textarea>

  <button id="add-record-btn">記録を追加</button>
</div>

<div class="section">
  <label for="filter-date">日付で表示</label>
  <input type="date" id="filter-date">
</div>

<div class="section">
  <h2>記録一覧</h2>
  <ul id="record-list" class="record-list"></ul>
</div>

<div class="section">
  <h2>体重推移グラフ</h2>
  <canvas id="weightChart" height="200"></canvas>
</div>

<div class="section">
  <h2>まとめコピー用テキスト</h2>
  <textarea id="copy-textarea" readonly placeholder="ここをコピーしてチャッピー（ChatGPT）にペーストすると概算カロリーがわかります"></textarea>
  <button id="copy-all-btn">全部コピー</button>
  <button id="open-chatgpt">チャッピーにカロリーについて聞いてみる。</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const dateInput = document.getElementById('date-input');
  const mealInput = document.getElementById('meal-input');
  const calorieInput = document.getElementById('calorie-input');
  const burncalInput = document.getElementById('burncal-input');
  const weightInput = document.getElementById('weight-input');
  const memoInput = document.getElementById('memo-input');
  const addRecordBtn = document.getElementById('add-record-btn');
  const recordList = document.getElementById('record-list');
  const copyTextarea = document.getElementById('copy-textarea');
  const copyAllBtn = document.getElementById('copy-all-btn');
  const openChatGPTBtn = document.getElementById('open-chatgpt');
  const filterDateInput = document.getElementById('filter-date');
  const ctx = document.getElementById('weightChart').getContext('2d');

  let records = [];
  let editIndex = null;
  let chart;

  function saveRecords() {
    localStorage.setItem('dietRecords', JSON.stringify(records));
  }

  const saved = localStorage.getItem('dietRecords');
  if (saved) {
    records = JSON.parse(saved);
  }

  function formatDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    return d.toLocaleDateString('ja-JP');
  }

  function renderRecords(filterDate = '') {
    recordList.innerHTML = '';
    const filtered = filterDate ? records.filter(r => r.date === filterDate) : records;
    filtered.forEach((rec, i) => {
      const li = document.createElement('li');
      li.innerHTML = `
        <strong>${formatDate(rec.date)}</strong><br/>
        食事: ${rec.meal}<br/>
        カロリー: ${rec.calorie ? rec.calorie + ' kcal' : '未入力'}<br/>
        消費: ${rec.burncal ? rec.burncal + ' kcal' : '-'}<br/>
        体重: ${rec.weight ? rec.weight + ' kg' : '未入力'}<br/>
        メモ: ${rec.memo || '-'}
        <button class="edit-btn" data-index="${i}">編集</button>
        <button class="delete-btn" data-index="${i}">削除</button>
      `;
      recordList.appendChild(li);
    });
    updateCopyText(filtered);
    updateChart(filtered);
  }

  function updateCopyText(data) {
    if(data.length === 0) {
      copyTextarea.value = '';
      return;
    }
    const sortedByDate = [...data].sort((a,b) => b.date.localeCompare(a.date));
    const latestDate = sortedByDate[0].date;
    const latestRecords = data.filter(r => r.date === latestDate);
    let text = latestRecords.map(r => {
      return `${formatDate(r.date)} 食事: ${r.meal} (${r.calorie ? r.calorie + ' kcal' : 'カロリー未入力'})` +
             `${r.burncal ? ' 消費: ' + r.burncal + ' kcal' : ''} 体重: ${r.weight ? r.weight + ' kg' : '未入力'} メモ: ${r.memo || '-'}`;
    }).join('\n');
    copyTextarea.value = text;
  }

  function updateChart(data) {
    const dateMap = {};
    data.forEach(r => {
      if (r.weight) {
        if (!dateMap[r.date] || new Date(r.date) > new Date(dateMap[r.date].time)) {
          dateMap[r.date] = {weight: parseFloat(r.weight), time: r.date};
        }
      }
    });
    const sortedDates = Object.keys(dateMap).sort((a,b) => new Date(a) - new Date(b));
    const labels = sortedDates.map(d => formatDate(d));
    const weights = sortedDates.map(d => dateMap[d].weight);
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: '体重 (kg)',
          data: weights,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52, 152, 219, 0.2)',
          fill: true,
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: false } }
      }
    });
  }

  addRecordBtn.addEventListener('click', () => {
    const dateVal = dateInput.value;
    const mealVal = mealInput.value.trim();
    const calorieVal = calorieInput.value.trim();
    const burncalVal = burncalInput.value.trim();
    const weightVal = weightInput.value.trim();
    const memoVal = memoInput.value.trim();

    if(!dateVal) { alert('日付を選んでください'); return; }
    if(!mealVal && !weightVal) { alert('食事または体重のどちらかは入力してください'); return; }

    if(editIndex !== null) {
      records[editIndex] = {date: dateVal, meal: mealVal, calorie: calorieVal, burncal: burncalVal, weight: weightVal, memo: memoVal};
      editIndex = null;
      addRecordBtn.textContent = '記録を追加';
    } else {
      records.push({date: dateVal, meal: mealVal, calorie: calorieVal, burncal: burncalVal, weight: weightVal, memo: memoVal});
    }

    saveRecords();
    dateInput.value = ''; mealInput.value = ''; calorieInput.value = ''; burncalInput.value = ''; weightInput.value = ''; memoInput.value = '';
    renderRecords(filterDateInput.value);
  });

  recordList.addEventListener('click', (e) => {
    if(e.target.classList.contains('delete-btn')) {
      const idx = e.target.dataset.index;
      if(confirm('この記録を削除しますか？')) { records.splice(idx, 1); saveRecords(); renderRecords(filterDateInput.value); }
    } else if(e.target.classList.contains('edit-btn')) {
      const idx = e.target.dataset.index;
      const rec = records[idx];
      dateInput.value = rec.date; mealInput.value = rec.meal; calorieInput.value = rec.calorie;
      burncalInput.value = rec.burncal; weightInput.value = rec.weight; memoInput.value = rec.memo;
      editIndex = idx;
      addRecordBtn.textContent = '編集を保存';
      window.scrollTo({top: 0, behavior: 'smooth'});
    }
  });

  copyAllBtn.addEventListener('click', () => {
    copyTextarea.select();
    document.execCommand('copy');
    alert('最新の日付の記録をコピーしました！');
  });

  openChatGPTBtn.addEventListener('click', () => {
    window.open('https://chat.openai.com/', '_blank');
  });

  filterDateInput.addEventListener('change', () => {
    renderRecords(filterDateInput.value);
  });

  renderRecords();
</script>

</body>
</html>
